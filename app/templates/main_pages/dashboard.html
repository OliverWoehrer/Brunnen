{% extends "main_pages/base.html" %}
{% import "macros/cards.html" as cards %}
{% import "macros/buttons.html" as buttons %}

{% set page_title = "Dashboard" %}
{% set dashboard_selector = "selected" %}
{% set heading = "Dashboard" %}

{% block style %}
<style>
.board {
    height: 99%;
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: flex-start;
    align-content: stretch;
}

.logs {
    flex-grow: 1;
}

th {
    background: white;
    position: sticky;
    top: 0; /* Don't forget this, required for the stickiness */
    box-shadow: 0 2px 5px -1px rgba(0, 0, 0, 0.4);
    background: #F1F1F1;
}
.scrollable { /* use for "main" to make content scrollable */
    height: 1px;
    overflow: auto;
}
@media (max-width: 992px) {
    .scrollable {
        min-height: 300px;
    }
}
</style>
{% endblock %}

{% block main %}
<div class="board">
    {% call cards.white() %}
    <div class="app">
        <header>
            <h2 class="w3-left">Live</h2>
            <div class="w3-right">
                {{ buttons.link_primary("More Details", url_for("web.dashboard.live")) }}
            </div>
        </header>
        <main>
            <p>
                Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
            </p>
        </main>
    </div>
    {% endcall %}
    {% call cards.white(stylings="flex-grow: 1;") %}
    <div class="app">
        <header>
            <h2 class="w3-left">Logs</h2>
            <div class="w3-right">
                {{ buttons.link_primary("See All", url_for("web.dashboard.logs")) }}
            </div>
        </header>
        <main class="scrollable w3-round-large" style="margin-bottom: 8px;">
            <table id="logs_table" class="w3-table w3-striped w3-round-large"> </table>
        </main>
    </div>
    {% endcall %}
    {% call cards.white(stylings="width: 100%") %}
    <div style="width: 100%;">
        <h2>Measurements</h2>
    </div>
    {% endcall %}
</div>
{% endblock %}

{% block script %}
<script src="{{ url_for('static',filename='script.js') }}"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script>
    const DELTA_DAYS = 10
    requestLatestSyncTime();

    function requestLatestSyncTime() {
        $.ajax({ 
            url: "/api/web/sync", 
            type: "get",
            accepts: "application/json",
            success: function(res) {
                const lastSync = res["last_sync"];
                const delta = DELTA_DAYS * 24 * 60 * 60 * 1000; // days in milliseconds
                stopTime = new Date(lastSync);
                startTime = new Date (stopTime.getTime() - delta);
                requestDashboardValues(startTime, stopTime);
            },
            error: function(res) {
                console.log("Failed to request time of last sync:"+res);
            }
        });
    }

    function requestDashboardValues(startTime, stopTime) {
        requestLogs(startTime, stopTime);
        requestData(startTime, stopTime);
    }

    function requestLogs(startTime, stopTime) {
        startString = startTime.toISOString().replace("Z","");
        stopString = stopTime.toISOString().replace("Z","");
        $.ajax({ 
            url: "/api/web/logs", 
            type: "get",
            accepts: "application/json",
            data: { start: startString, stop: stopString },
            success: function(res) {
                // Parse Reponse:
                columns = res["columns"];
                data = res["data"];

                // Get DOM Element for Table:
                let logsTable = document.getElementById("logs_table");

                // Insert User as Table Rows:
                fillTable(logsTable, columns, data)
            },
            error: function(res) {
                console.log("Failed to request logs:"+res);
            }
        });
    }

    function requestData(startTime, stopTime) {
        startString = startTime.toISOString().replace("Z","");
        stopString = stopTime.toISOString().replace("Z","");
        $.ajax({ 
            url: "/api/web/data", 
            type: "get",
            accepts: "application/json",
            data: { start: startString, stop: stopString },
            success: function(res) {
                // Parse Reponse:
                columns = res["columns"];
                data = res["data"];

                // Get DOM Element for Table:
                let logsTable = document.getElementById("logs_table");

                // Insert User as Table Rows:
                fillTable(logsTable, columns, data)
            },
            error: function(res) {
                console.log("Failed to request logs:"+res);
            }
        });
    }
</script>
{% endblock %}