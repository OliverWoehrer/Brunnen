<!DOCTYPE html>
<html>
<head>
    <title>Brunnen IoT</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/1.0.0/chartjs-plugin-zoom.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/0.8.3/jquery.csv.min.js"></script>
</head>

<body>
    <p>
        Plot Data File
    </p>
    <input type="file" id="file-input" multiple>
    <div id="btnHolder">
        upload files
    </div>
    <div>
        <canvas id="myChart"></canvas>
    </div>

    <script type="text/javascript">
        var myChart;
        var chartCanvas = document.getElementById('myChart');
        var config = {
            type: 'line',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                plugins: {
                    tooltip: false,
                    zoom: {
                        zoom: {
                            drag: {
                                enabled: true
                            },
                            mode: 'x',
                        }
                    }
                }
            }
        };
        
        //Initalize Asynchronous File Reader:
        var fileInput = document.getElementById('file-input');
        fileInput.addEventListener('change', function() {
            document.getElementById("btnHolder").innerHTML = "uploading data files...";
            config.data.labels = [];
            config.data.datasets = [];
            readmultifiles(this.files);
        });

        function readmultifiles(files) {
            var reader = new FileReader();  
            function readFile(index) {
                if (index >= files.length) {
                    document.getElementById("btnHolder").innerHTML = '<button onclick="makeChart()">Plot Data</button>';
                    return;
                }
                var file = files[index];
                reader.onload = function(e) {  
                    parseDataFile(e.target.result);
                    readFile(index+1);
                }
                reader.readAsText(file);
            }
            readFile(0);
        }

        function parseDataFile(raw) {
            const content = $.csv.toObjects(raw);
            const timestamp = content.map(function(d) {return d.Timestamp});
            config.data.labels = timestamp;
            const flow = content.map(function(d) {return d.Flow});
            config.data.datasets.push({
                label: 'Flow',
                data: flow,
                borderColor: 'rgb(68, 114, 196)',
            });
            const pressure = content.map(function(d) {return d.Pressure});
            config.data.datasets.push({
                label: 'Pressure',
                data: pressure,
                borderColor: 'rgb(237, 125, 49)'
            });
            const level = content.map(function(d) {return d.Level});
            config.data.datasets.push({
                label: 'Level',
                data: level,
                borderColor: 'rgb(165, 165, 165)'
            });
        }

        function makeChart() {
            console.log("plotting chart");
            if (myChart) {
                myChart.destroy();
            }
            document.getElementById("btnHolder").innerHTML = '<button onclick="resetZoom()">Reset Zoom</button>';
            myChart = new Chart(chartCanvas, config);
        }

        function resetZoom() {
            myChart.resetZoom();
        }

    </script>
</body>

</html>